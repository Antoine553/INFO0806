---
title: "INFO0806 – Statistiques appliquées"
author: "FUZELLIER Maxence, BARBET Antoine"
date: "`r format(Sys.time(), '%d %B, %Y')`"
language: R
cran: http://cran.rstudio.com
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 3 # three depths of headings (#, ## and ###)
editor_options: 
  chunk_output_type: inline
---

<style>
body {
  text-align: justify;
  font-size: 14pt;
}
</style>

<body>

******

<center>
**↓↓ Accès au projet ↓↓**
<br />
[Lien GitHub du projet](https://github.com/Antoine553/INFO0806)
</center>

******

<br />
# **Introduction**

<br />

Dans le cadre du module de statistiques appliquées, nous avions abordé les bases des statistiques et pris en main des outils permettant d'effectuer des operation statistique avancée grâce au langage R, à partir d’un jeu de données. Ainsi, notre choix s'est porté sur des données statistiques relatives à <bold>je sais pas</bold>. Celles-ci proviennent du site internet <bold>je sais pas</bold>.

Ce projet de statistiques appliquées consiste en l'utilisation d'outils R adaptés afin d'effectuer des régression linéaire sur notre jeu de données et produire un rapport.
<br />

******

<br />
# **Outils et environnement de travail**


## R et RStudio 
 
R est un langage de programmation dont le but est de pouvoir traiter et organiser des jeux de données afin de pouvoir y appliquer des tests statistiques plus ou moins complexes et se représenter ces données graphiquement à l'aide d'une grande variété de graphiques disponibles. RStudio est une application proposant un environnement de développement et des outils adaptés au langage et à l'environnement de programmation R. 

La fonction principale de RStudio consiste à faciliter le développement d'applications en langage R. Pour ce faire, le programme dispose de nombreux outils qui vous permettent notamment de créer des scripts, compiler du code, créer des graphes, ainsi que de travailler avec divers jeux de données. 

<br />

## R markdown

L’extension R markdown permet de générer des documents de manière dynamique en mélangeant texte mis en forme et résultats produits par du code R. Les documents générés peuvent être au format HTML, PDF, Word, et bien d’autres. C’est donc un outil très pratique pour l’exportation, la communication et la diffusion de résultats d’analyse.

<br />

## Outils complémentaires 

* *tidyverse* : Il s’agit d’une collection d’extensions relatives à la science des données, et permettant la manipulation des tableaux de données, l’import/export de données, la manipulation de variables ou, entre autres, la visualisation de données ;
* *data.table* : Extension et manipulation avancée des tableaux de données ;
* *plotly* et *highcharter* : Comme *ggplot2* (compris dans le *tidyverse*), ces packages permettent la visualisation de données, à la différence près qu’ils rendent ces graphiques interactifs ;
* *hrbrthemes* : Thèmes pour *ggplot2*.

<br />
<br />

******

<br />

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load, message=FALSE, warning=FALSE, include=FALSE}
install.packages("GGally", repo = "http://cran.rstudio.com/")

library(data.table)
library(tidyverse)
library(hrbrthemes)
library(plotly)
library(gridExtra)
library(GGally)
library(car)
```

# **Données**

Chargement des jeux de données :

Notre jeu de données comporte 102 individus décrits par 6 variables :

* education : nombre moyen d'années d'études des titulaires de profession ;
* income : Le revenu moyen des titulaires de profession, en dollars ;
* women : pourcentage de femmes dans la profession ; 
* prestige : La cote de prestige moyenne pour la profession ;
* census : Le code de la profession utilisé dans l'enquête ;
* type : Professionnel et gestionnaire (prof), col blanc (wc), col bleu (bc) ou manquant (NA) (Fox et Weisberg 2011)

```{r datasets, message=FALSE}
data <- read_csv("data/prestige.csv") %>% as_tibble()

data <- data %>% 
  na.omit()
data
```
<br />

```{r}
viz_edu <- data %>% ggplot(aes(x = prestige, y = education, col = type)) + geom_point() + theme_ipsum()
viz_edu <- ggplotly(viz_edu)

viz_inc <- data %>% ggplot(aes(x = prestige, y = income, col = type)) + geom_point() + theme_ipsum()
viz_inc <- ggplotly(viz_inc)

viz_women <- data %>% ggplot(aes(x = prestige, y = women, col = type)) + geom_point() + theme_ipsum()
viz_women <- ggplotly(viz_women)

viz_census <- data %>% ggplot(aes(x = prestige, y = census, col = type)) + geom_point() + theme_ipsum()
viz_census <- ggplotly(viz_census)

subplot(viz_edu, viz_inc, viz_women, viz_census, nrows = 2, margin = 0.07)
```



# **Régression linéaire**

En statistiques et en apprentissage automatique, un modèle de régression linéaire est un modèle de régression qui cherche à établir une relation linéaire entre une variable, dite expliquée, et une ou plusieurs variables, dites explicatives.

Dans un premier temps, nous pouvons étudier rapidement d'éventuelles corrélations entre deux variables à l'aide d'un nuage de points. Ici, nous utilisons la fonction *ggpairs* afin de pouvoir en observer plusieurs en même temps.

```{r , message=FALSE}
generate_scatterM <- function(data, mapping){
  data %>% ggplot(mapping = mapping) + geom_point(size = 0.8) + 
    geom_smooth(method = loess, color = "red", size = 0.85, se = FALSE) +
    geom_smooth(method = lm, color = "blue", size = 0.85, se = FALSE) +
    theme_ipsum()
}

scatterM <- data %>% ggpairs(columns = 1:5, lower = list(continuous = generate_scatterM))

scatterM <- ggplotly(scatterM)
scatterM
```

Avec les observations précédentes, nous pouvons déjà écarter certaines linéarités et choisir lesquelles sont intéressantes à étudier. Ici, nous reprenons donc la relation entre la variable *prestige* (il s’agit d’un score de prestige relatif à la profession) et la variable *education* (qui reflète le niveau d’étude). Cette fois nous utilisons *ggplot* pour une meilleure représentation.

```{r education}
education <- data %>% 
  ggplot(aes(x = education, y = prestige)) +
  geom_point() +
  geom_smooth(method = loess, color = "red", fill = "#69b3a2", se = T) +
  geom_smooth(method = lm, color = "blue", se = F) +
  theme_ipsum()

scatter_edu <- ggplotly(education)
scatter_edu
```
La droite bleue est définie par la méthode des moindres carrés (MSE), il s'agit d'une droite de régression linéaire entre les variables *education* et *prestige*.

La courbe rouge indique la tendance globale entre ces deux variables, il s'agit d'une courbe de régression de type lowess. Les deux courbes extérieures représentent l'intervalle de confiance de cette courbe de régression.

On constate que que la droite de régression est presque toujours comprise dans l’intervalle de confiance, l'hypothèse de linéarite entre les variables *education* et *prestige* est donc acceptable.

<br />

Nous testons aussi la relation entre les variables *income* et *prestige*.

```{r income}
income <- data %>% 
  ggplot(aes(x = income, y = prestige)) +
  geom_point() +
  geom_smooth(method = loess, color = "red", fill = "#69b3a2", se = T) +
  geom_smooth(method = lm, color = "blue", se = F) +
  theme_ipsum()

scatter_inc <- ggplotly(income)
scatter_inc
```

Ici, en regardant la forme du lien entre la variable entre les deux variables, on s’aperçoit que la droite de régression suis bien moins l’intervalle de confiance de la courbe lowess. l’hypothèse de linéarité est alors plus critiquable.
<br />
Pour déterminer la droite de régression, on ajuste un modèle linéaire simple aux données, à l’aide de la fonction “lm”.

```{r}
lin_model1 <- lm(prestige~education, data = Prestige)
lin_model1
```
« Intercept » correspond ici à l’ordonnée à l’origine le « b » de notre droite et le « x » est la pente de la droite ce qui correspond au « b » dans notre notation. L’équation, de notre droite est donc y = 5.361x + -10.732.

```{r lagplot}
bacf <- acf(residuals(lin_model1), plot = F)
bacfdf <- with(bacf, data.frame(lag, acf))
conf.level <- 0.95
ciline <- qnorm((1 - conf.level)/2)/sqrt(length(residuals(lin_model1)))

lag_plot <- bacfdf %>%
  ggplot(aes(x = lag, y = acf)) +
  geom_hline(aes(yintercept = 0)) +
  geom_segment(aes(xend = lag, yend = 0)) +
  geom_hline(aes(yintercept = ciline), linetype = 3, color = 'darkblue') +     
  geom_hline(aes(yintercept = -ciline), linetype = 3, color = 'darkblue') +
  theme_ipsum()

lag_plot <- ggplotly(lag_plot, tooltip = c("lag", "acf"))
lag_plot
```

```{r durbinWatson_edu}
durbinWatsonTest(lin_model1)
```

```{r qq_edu}
qq_edu <- lin_model1 %>%
  ggplot(aes(sample = residuals(lin_model1) / 10))+
  stat_qq() + stat_qq_line() +
  #theme_ipsum() +
  labs(x = "Theoretical Quantiles\nlm(prestige ~ education)", 
       y = "Standardized residuals")

#qq_edu <- ggplotly(qq_edu)
qq_edu
```

```{r shapiro_edu}
shapiro.test(residuals(lin_model1))
```

```{r}
lin_model2 <- lm(prestige~income, data = Prestige)
lin_model2
```

```{r qq_inc}
qq_inc <- lin_model2 %>%
  ggplot(aes(sample = residuals(lin_model2) / 10))+
  stat_qq() + stat_qq_line() +
  #theme_ipsum() +
  labs(x = "Theoretical Quantiles\nlm(prestige ~ income)", 
       y = "Standardized residuals")

#qq_inc <- ggplotly(qq_inc)
qq_inc
```


```{r shapiro_inc}
shapiro.test(residuals(lin_model2))
```

```{r}
plot(lin_model1, 3)
```

```{r}
ncvTest(lin_model1)
```

```{r}
plot(lin_model1,1)
```

```{r}
summary(lin_model1)
```

```{r}
confint(lin_model1)
```

```{r}
influenceIndexPlot(lin_model1)
```

```{r}
outlierTest(lin_model1)
```

```{r}
lin_model1bis <- lm(prestige~education, data=Prestige[-c(53,67),])
compareCoefs(lin_model1 ,lin_model1bis) 
```

```{r}
my_df <- data.frame(education=c(10.25))
predict(lin_model1, newdata=my_df)
```

```{r}
predict(lin_model1, newdata=my_df, interval="prediction")
predict(lin_model1, newdata=my_df, interval="confidence")
```

```{r}
my_df <- data.frame(education=c(10.25, 11.25, 12.25))
predict(lin_model1, newdata=my_df,interval="confidence")
```

```{r}
my_pres <- Prestige
my_pres$res <-residuals(lin_model1)
head(my_pres)
```

```{r}
my_pres$fitted <-fitted(lin_model1)
head(my_pres)
```

```{r}
head(predict(lin_model1))
head(fitted(lin_model1))
```

```{r}
vcov(lin_model1)
```

```{r}
ggplot(Prestige, aes(y=prestige, x=education))+
  geom_point()+
  geom_smooth(colour="red", method="lm", fill="red") +
  ylab("Prestige")+
  xlab("education") +
  theme_classic()+
  annotate("text", x = 9, y = 80, label = "prestige = -10.73 + 5.36 * education\n (pval<0.001)")
```

```{r}
int_pred <- predict(lin_model1, interval="prediction")
my_prest2 <-cbind(Prestige, int_pred)
head(my_prest2)
```

```{r}
ggplot(my_prest2, aes(y=prestige, x=education))+
  geom_point()+
  geom_smooth(colour="red", method="lm", fill="red") +
  geom_line(aes(y=lwr), color = "red", linetype = "dashed")+
  geom_line(aes(y=upr), color = "red", linetype = "dashed")+    
  ylab("Prestige")+
  xlab("education") +
  theme_classic()+
  annotate("text", x = 9, y = 80, label = "prestige = -10.73 + 5.36 * education\n (pval<0.001)")
```


</body>